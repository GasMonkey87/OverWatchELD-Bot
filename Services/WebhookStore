using System;
using System.Collections.Generic;
using System.IO;
using System.Text.Json;

namespace OverWatchELD.VtcBot.Services
{
    public sealed class WebhookStore
    {
        private readonly string _path;
        private readonly object _gate = new();
        private StoreModel _model;

        private static readonly JsonSerializerOptions ReadOpts = new() { PropertyNameCaseInsensitive = true };
        private static readonly JsonSerializerOptions WriteOpts = new() { WriteIndented = true };

        public WebhookStore(string path)
        {
            _path = path;
            _model = LoadOrDefault(path);
        }

        private static StoreModel LoadOrDefault(string path)
        {
            try
            {
                if (!File.Exists(path)) return new StoreModel();
                var json = File.ReadAllText(path);
                return JsonSerializer.Deserialize<StoreModel>(json, ReadOpts) ?? new StoreModel();
            }
            catch { return new StoreModel(); }
        }

        private void SaveUnsafe()
        {
            Directory.CreateDirectory(Path.GetDirectoryName(_path)!);
            var tmp = _path + ".tmp";
            File.WriteAllText(tmp, JsonSerializer.Serialize(_model, WriteOpts));
            File.Copy(tmp, _path, true);
            try { File.Delete(tmp); } catch { }
        }

        public bool TryGet(ulong guildId, string key, out string url)
        {
            lock (_gate)
            {
                url = "";
                if (_model.Guilds.TryGetValue(guildId.ToString(), out var g) &&
                    g.Webhooks.TryGetValue(key, out var found))
                {
                    url = found;
                    return true;
                }
                return false;
            }
        }

        public IReadOnlyDictionary<string, string> GetGuild(ulong guildId)
        {
            lock (_gate)
            {
                if (_model.Guilds.TryGetValue(guildId.ToString(), out var g))
                    return new Dictionary<string, string>(g.Webhooks, StringComparer.OrdinalIgnoreCase);

                return new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
            }
        }

        public void Set(ulong guildId, string key, string url)
        {
            lock (_gate)
            {
                if (!_model.Guilds.TryGetValue(guildId.ToString(), out var g))
                {
                    g = new GuildModel();
                    _model.Guilds[guildId.ToString()] = g;
                }
                g.Webhooks[key] = url;
                SaveUnsafe();
            }
        }

        public bool Remove(ulong guildId, string key)
        {
            lock (_gate)
            {
                if (_model.Guilds.TryGetValue(guildId.ToString(), out var g) &&
                    g.Webhooks.Remove(key))
                {
                    SaveUnsafe();
                    return true;
                }
                return false;
            }
        }

        private sealed class StoreModel
        {
            public Dictionary<string, GuildModel> Guilds { get; set; } = new();
        }

        private sealed class GuildModel
        {
            public Dictionary<string, string> Webhooks { get; set; } = new(StringComparer.OrdinalIgnoreCase);
        }
    }
}
